#!/usr/bin/env bash
set -euo pipefail

DOMAIN="${DOMAIN:-{{ deployment_domain }}}"
EMAIL="${EMAIL:-{{ deployment_email }}}"
BASE="/opt/vscode-server"
ENV="${LETSENCRYPT_ENV:-production}"

CERT_DIR="$BASE/data/nginx/letsencrypt/live/$DOMAIN"

if [[ -d "$CERT_DIR" ]]; then
  echo "‚úÖ Certificate already exists for $DOMAIN"
  exit 0
fi

echo "‚ö†Ô∏è  ${ENV^^}: Let's Encrypt rate limits apply"
echo "üöÄ Starting nginx for ACME challenge..."

docker compose -f "$BASE/docker-compose.yml" up -d nginx

echo "‚è≥ Waiting for nginx to bind port 80..."
for i in {1..20}; do
  if curl -fs http://localhost >/dev/null 2>&1; then
    break
  fi
  sleep 2
done

if ! curl -fs http://localhost >/dev/null 2>&1; then
  echo "‚ùå nginx did not become ready"
  docker compose -f "$BASE/docker-compose.yml" logs nginx
  exit 1
fi

STAGING_FLAG=""
[[ "$ENV" == "staging" ]] && STAGING_FLAG="--staging"

echo "üîê Requesting certificate for $DOMAIN..."

docker compose -f "$BASE/docker-compose.yml" run --rm certbot certonly \
  --webroot \
  --webroot-path /var/www/certbot \
  --email "$EMAIL" \
  --agree-tos \
  --no-eff-email \
  $STAGING_FLAG \
  -d "$DOMAIN"

echo "üîÑ Reloading nginx with HTTPS..."

docker compose -f "$BASE/docker-compose.yml" exec nginx nginx -s reload

echo "‚úÖ TLS bootstrap complete"
