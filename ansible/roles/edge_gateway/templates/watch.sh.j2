#!/bin/sh
set -e

echo "[EDGE WATCHER ELITE] started"

SITES_DIR=/sites
TMP_DIR=/tmp/edge-sites

generate_configs() {

  echo "[EDGE WATCHER] rebuilding configs"

  # -------------------------------------------------
  # recreate temp directory safely
  # -------------------------------------------------
  rm -rf "$TMP_DIR"
  mkdir -p "$TMP_DIR"

  # -------------------------------------------------
  # discover running containers
  # -------------------------------------------------
  docker ps --format '{{ "{{.ID}}" }}' | while read -r id; do

    enable=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.enable\" }}" }}' "$id" 2>/dev/null || true)
    [ "$enable" = "true" ] || continue

    domain=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.domain\" }}" }}' "$id" 2>/dev/null || true)
    port=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.port\" }}" }}' "$id" 2>/dev/null || true)
    name=$(docker inspect -f '{{ "{{.Name}}" }}' "$id" 2>/dev/null | sed 's/\///')

    # skip incomplete configs
    [ -n "$domain" ] || continue
    [ -n "$port" ] || continue
    [ -n "$name" ] || continue

cat > $TMP_DIR/$domain.conf <<EOF

# ------------------------------------------------------------

# HTTP

# ------------------------------------------------------------

server {
listen 80;
server_name $domain;

```
location /.well-known/acme-challenge/ {
    root /var/www/certbot;
}

location / {
    return 301 https://\$host\$request_uri;
}
```

}

# ------------------------------------------------------------

# HTTPS

# ------------------------------------------------------------

server {
listen 443 ssl;
server_name $domain;

```
ssl_certificate /etc/letsencrypt/live/$domain/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/$domain/privkey.pem;

ssl_protocols TLSv1.2 TLSv1.3;

location / {
    proxy_pass http://$name:$port;

    proxy_http_version 1.1;
    proxy_set_header Upgrade \$http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_set_header Host \$host;
    proxy_set_header X-Real-IP \$remote_addr;
    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto \$scheme;
}
```

}
EOF

  done

  # -------------------------------------------------
  # replace live configs safely
  # -------------------------------------------------
  rm -f "$SITES_DIR"/*.conf 2>/dev/null || true
  cp "$TMP_DIR"/*.conf "$SITES_DIR"/ 2>/dev/null || true

  # -------------------------------------------------
  # validate BEFORE reload
  # -------------------------------------------------
  if docker exec edge-nginx nginx -t >/dev/null 2>&1; then
      docker exec edge-nginx nginx -s reload >/dev/null 2>&1
      echo "[EDGE WATCHER] nginx reloaded"
  else
      echo "[EDGE WATCHER] config invalid â€” reload skipped"
  fi
}

# =================================================
# INITIAL GENERATION
# =================================================
generate_configs

# =================================================
# ELITE EVENT WATCHING
# =================================================
docker events \
  --filter event=start \
  --filter event=die \
  --filter event=destroy \
  | while read -r line; do
      echo "[EDGE WATCHER] change detected"
      generate_configs
done
