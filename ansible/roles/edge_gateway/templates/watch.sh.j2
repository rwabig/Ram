#!/bin/sh
set -e

echo "[EDGE WATCHER ELITE] started"

SITES_DIR=/sites
TMP_DIR=/tmp/edge-sites

generate_configs() {

  echo "[EDGE WATCHER] rebuilding configs"

  rm -rf $TMP_DIR
  mkdir -p $TMP_DIR

  docker ps --format '{{ "{{.ID}}" }}' | while read id; do

    enable=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.enable\" }}" }}' $id 2>/dev/null)

    [ "$enable" = "true" ] || continue

    domain=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.domain\" }}" }}' $id)
    port=$(docker inspect -f '{{ "{{ index .Config.Labels \"edge.port\" }}" }}' $id)
    name=$(docker inspect -f '{{ "{{.Name}}" }}' $id | sed 's/\///')

cat > $TMP_DIR/$domain.conf <<EOF
server {
    listen 80;
    server_name $domain;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        proxy_pass http://$name:$port;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
EOF

  done

  # -------------------------------------------------
  # validate config BEFORE replacing live config
  # -------------------------------------------------
  rm -f $SITES_DIR/*.conf
  cp $TMP_DIR/*.conf $SITES_DIR/ 2>/dev/null || true

  if docker exec edge-nginx nginx -t; then
      docker exec edge-nginx nginx -s reload
      echo "[EDGE WATCHER] nginx reloaded"
  else
      echo "[EDGE WATCHER] config invalid â€” reload skipped"
  fi
}

# initial run
generate_configs

# -------------------------------------------------
# ELITE EVENT FILTERING
# -------------------------------------------------
docker events \
  --filter event=start \
  --filter event=die \
  --filter event=destroy \
  | while read line; do
      echo "[EDGE WATCHER] change detected"
      generate_configs
done
