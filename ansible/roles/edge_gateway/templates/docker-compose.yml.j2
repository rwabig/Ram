version: "3.9"

services:

  # ============================================================
  # EDGE NGINX GATEWAY
  # ============================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: edge-nginx
    restart: unless-stopped

    volumes:
      # Core config
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # Auto-generated vhosts
      - ./nginx/sites:/etc/nginx/conf.d:ro

      # TLS
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

    ports:
      - "80:80"
      - "443:443"

    networks:
      - {{ edge_gateway_network }}

    healthcheck:
      test: ["CMD-SHELL", "nginx -t"]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 20s

    security_opt:
      - no-new-privileges:true

    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run


  # ============================================================
  # CERTBOT AUTO RENEWER
  # ============================================================
  certbot:
    image: certbot/certbot
    container_name: edge-certbot
    restart: unless-stopped

    entrypoint: /bin/sh
    command: >
      -c "trap exit TERM;
          while :; do
            certbot renew --webroot -w /var/www/certbot --quiet;
            sleep 12h;
          done"

    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

    networks:
      - {{ edge_gateway_network }}

    security_opt:
      - no-new-privileges:true


  # ============================================================
  # EDGE WATCHER (Docker Label Auto-Discovery)
  # ============================================================
  edge-watcher:
    image: docker:cli
    container_name: edge-watcher
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./nginx/sites:/sites
      - ./scripts:/scripts:ro

    entrypoint: /bin/sh
    command: /scripts/watch.sh

    networks:
      - {{ edge_gateway_network }}

    security_opt:
      - no-new-privileges:true


# ============================================================
# NETWORKS
# ============================================================
networks:
  {{ edge_gateway_network }}:
    external: true
