services:

  # ============================================================
  # EDGE NGINX GATEWAY
  # ============================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: edge-nginx
    restart: unless-stopped

    volumes:
      # --------------------------------------------------------
      # MAIN NGINX CONFIG
      # --------------------------------------------------------
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # --------------------------------------------------------
      # AUTO-GENERATED SITES
      # (mounted directly as conf.d)
      # --------------------------------------------------------
      - ./nginx/sites:/etc/nginx/conf.d

      # --------------------------------------------------------
      # TLS DATA (LETSENCRYPT)
      # --------------------------------------------------------
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

    ports:
      - "80:80"
      - "443:443"

    networks:
      - {{ edge_gateway_network }}

    # --------------------------------------------------------
    # HEALTH CHECK
    # validates nginx config continuously
    # --------------------------------------------------------
    healthcheck:
      test: ["CMD-SHELL", "nginx -t || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s


  # ============================================================
  # CERTBOT AUTO RENEWAL SERVICE
  # ============================================================
  certbot:
    image: certbot/certbot
    container_name: edge-certbot
    restart: unless-stopped

    entrypoint: /bin/sh
    command: >
      -c "while :;
      do sleep 12h;
      certbot renew --webroot -w /var/www/certbot;
      done"

    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot

    networks:
      - {{ edge_gateway_network }}


  # ============================================================
  # EDGE WATCHER (AUTO DISCOVERY / AUTO RELOAD)
  # ============================================================
  edge-watcher:
    image: docker:cli
    container_name: edge-watcher
    restart: unless-stopped

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./nginx/sites:/sites
      - ./scripts:/scripts

    entrypoint: /bin/sh
    command: /scripts/watch.sh

    networks:
      - {{ edge_gateway_network }}


# ============================================================
# NETWORKS
# ============================================================
networks:
  {{ edge_gateway_network }}:
    external: true
