---
# ============================================================
# EDGE GATEWAY â€” CORE DIRECTORIES
# ============================================================

- name: Create base directory
  file:
    path: "{{ edge_gateway_base_path }}"
    state: directory
    mode: "0755"

- name: Create nginx base directory
  file:
    path: "{{ edge_gateway_base_path }}/nginx"
    state: directory
    mode: "0755"

# This directory will be mounted directly to /etc/nginx/conf.d
- name: Create nginx sites directory (mounted as conf.d)
  file:
    path: "{{ edge_gateway_base_path }}/nginx/sites"
    state: directory
    mode: "0755"

- name: Create certbot directories
  file:
    path: "{{ edge_gateway_base_path }}/certbot/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf
    - www

- name: Create edge scripts directory
  file:
    path: "{{ edge_gateway_base_path }}/scripts"
    state: directory
    mode: "0755"

- name: Create edge app registry directory
  file:
    path: "{{ edge_gateway_base_path }}/apps"
    state: directory
    mode: "0755"

# ============================================================
# DOCKER NETWORK
# ============================================================

- name: Create docker network
  community.docker.docker_network:
    name: "{{ edge_gateway_network }}"

# ============================================================
# DOCKER LABEL AUTO DISCOVERY (ZERO-TOUCH ONBOARDING)
# ============================================================

- name: Get running container IDs
  command: docker ps -q
  register: running_containers
  changed_when: false

- name: Initialize dynamic apps list
  set_fact:
    edge_gateway_apps_dynamic: []

- name: Inspect running containers
  command: docker inspect {{ item }}
  register: container_inspect
  loop: "{{ running_containers.stdout_lines }}"
  changed_when: false

- name: Build edge apps from docker labels
  set_fact:
    edge_gateway_apps_dynamic: "{{ edge_gateway_apps_dynamic + [ {
        'domain': container.Config.Labels['edge.domain'],
        'upstream': (container.Name | regex_replace('^/', '')) ~ ':' ~ container.Config.Labels['edge.port']
      } ] }}"
  vars:
    container: "{{ item.stdout | from_json | first }}"
  loop: "{{ container_inspect.results }}"
  when:
    - item.stdout is defined
    - container.Config.Labels is defined
    - container.Config.Labels['edge.enable'] is defined
    - container.Config.Labels['edge.enable'] == "true"

- name: Validate discovered edge apps
  assert:
    that:
      - edge_gateway_apps_dynamic | length > 0
    fail_msg: "No containers found with edge.enable=true"
    quiet: true
  ignore_errors: true

- name: Remove duplicate edge apps
  set_fact:
    edge_gateway_apps_dynamic: "{{ edge_gateway_apps_dynamic | unique(attribute='domain') }}"

# ============================================================
# CLEAN OLD SITE CONFIGS
# ============================================================

- name: Discover existing nginx site configs
  find:
    paths: "{{ edge_gateway_base_path }}/nginx/sites"
    patterns: "*.conf"
    file_type: file
  register: existing_nginx_configs

- name: Remove old generated site configs
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ existing_nginx_configs.files }}"

# ============================================================
# CONFIGURATION FILES
# ============================================================

- name: Render docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ edge_gateway_base_path }}/docker-compose.yml"

- name: Render nginx.conf
  template:
    src: nginx.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/nginx.conf"
  notify: Reload edge nginx

- name: Render site configs (mounted as conf.d/*.conf)
  template:
    src: site.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/sites/{{ item.domain }}.conf"
  loop: "{{ edge_gateway_apps_dynamic }}"
  notify: Reload edge nginx

# ============================================================
# START STACK (FORCE RECREATE SAFE)
# ============================================================

- name: Start Edge Gateway stack
  command: docker compose up -d --force-recreate
  args:
    chdir: "{{ edge_gateway_base_path }}"

# ============================================================
# HEALTH CHECK
# ============================================================

- name: Wait for edge nginx container to exist
  command: docker inspect edge-nginx
  register: edge_exists
  retries: 10
  delay: 2
  until: edge_exists.rc == 0
  changed_when: false

- name: Wait for edge nginx to become healthy
  command: docker inspect --format='{{ "{{.State.Health.Status}}" }}' edge-nginx
  register: edge_health
  retries: 20
  delay: 3
  until: edge_health.stdout == "healthy"
  changed_when: false
  failed_when: edge_health.stdout != "healthy"

# ============================================================
# AUTO TLS ORCHESTRATION
# ============================================================

- name: Install TLS bootstrap script
  template:
    src: init-letsencrypt.sh.j2
    dest: "{{ edge_gateway_base_path }}/init-letsencrypt.sh"
    mode: "0755"

- name: Install TLS renewal script
  template:
    src: renew-certs.sh.j2
    dest: "{{ edge_gateway_base_path }}/renew-certs.sh"
    mode: "0755"

- name: Check if certificate exists
  stat:
    path: "{{ edge_gateway_base_path }}/certbot/conf/live/{{ item.domain }}/fullchain.pem"
  loop: "{{ edge_gateway_apps_dynamic }}"
  register: edge_tls_stats
  when: edge_gateway_apps_dynamic | length > 0

- name: Bootstrap TLS certificates
  command: "{{ edge_gateway_base_path }}/init-letsencrypt.sh {{ item.item.domain }}"
  args:
    chdir: "{{ edge_gateway_base_path }}"
  loop: "{{ edge_tls_stats.results }}"
  when:
    - edge_gateway_apps_dynamic | length > 0
    - not item.stat.exists

- name: Install certificate renewal cron
  cron:
    name: "Edge Gateway TLS renewal"
    minute: "0"
    hour: "3"
    job: "{{ edge_gateway_base_path }}/renew-certs.sh"

# ============================================================
# WATCHER INSTALL
# ============================================================

- name: Install edge watcher script
  template:
    src: watch.sh.j2
    dest: "{{ edge_gateway_base_path }}/scripts/watch.sh"
    mode: "0755"
