---
# ============================================================
# EDGE GATEWAY — CORE DIRECTORIES
# ============================================================

- name: Create base directory
  file:
    path: "{{ edge_gateway_base_path }}"
    state: directory
    mode: "0755"

- name: Create nginx base directory
  file:
    path: "{{ edge_gateway_base_path }}/nginx"
    state: directory
    mode: "0755"

- name: Create nginx conf.d directory
  file:
    path: "{{ edge_gateway_base_path }}/nginx/conf.d"
    state: directory
    mode: "0755"

- name: Create certbot directories
  file:
    path: "{{ edge_gateway_base_path }}/certbot/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf
    - www

- name: Create edge scripts directory
  file:
    path: "{{ edge_gateway_base_path }}/scripts"
    state: directory
    mode: "0755"

# ------------------------------------------------------------
# APP AUTO-REGISTRATION DIRECTORY
# ------------------------------------------------------------

- name: Create edge app registry directory
  file:
    path: "{{ edge_gateway_base_path }}/apps"
    state: directory
    mode: "0755"

# ============================================================
# DOCKER NETWORK
# ============================================================

- name: Create docker network
  community.docker.docker_network:
    name: "{{ edge_gateway_network }}"

# ============================================================
# LOAD REGISTERED APPS (FILE DISCOVERY)
# ============================================================

- name: Discover registered edge apps
  find:
    paths: "{{ edge_gateway_base_path }}/apps"
    patterns: "*.yml"
    file_type: file
  register: discovered_apps

- name: Initialize dynamic apps list
  set_fact:
    edge_gateway_apps_dynamic: []

- name: Build dynamic app list from files
  set_fact:
    edge_gateway_apps_dynamic: >-
      {{
        edge_gateway_apps_dynamic
        + [ lookup('file', item.path) | from_yaml ]
      }}
  loop: "{{ discovered_apps.files }}"
  when: discovered_apps.matched | int > 0

# ------------------------------------------------------------
# FALLBACK — backward compatibility
# ------------------------------------------------------------

- name: Fallback to static apps if none discovered
  set_fact:
    edge_gateway_apps_dynamic: "{{ edge_gateway_apps | default([]) }}"
  when: edge_gateway_apps_dynamic | length == 0

# ============================================================
# PHASE 2.5 — DOCKER LABEL AUTO DISCOVERY
# ============================================================

- name: Discover running docker containers
  community.docker.docker_host_info:
    containers: true
  register: docker_info

- name: Build edge apps from docker labels
  set_fact:
    edge_gateway_apps_dynamic: >-
      {{
        edge_gateway_apps_dynamic
        +
        [
          {
            "domain": item.Config.Labels["edge.domain"],
            "upstream": item.Name[1:] ~ ":" ~ item.Config.Labels["edge.port"]
          }
        ]
      }}
  loop: "{{ docker_info.containers }}"
  when:
    - item.Config.Labels is defined
    - item.Config.Labels["edge.enable"] is defined
    - item.Config.Labels["edge.enable"] == "true"

# ------------------------------------------------------------
# REMOVE DUPLICATES (ELITE SAFETY)
# ------------------------------------------------------------

- name: Remove duplicate edge apps
  set_fact:
    edge_gateway_apps_dynamic: "{{ edge_gateway_apps_dynamic | unique(attribute='domain') }}"

# ============================================================
# CLEAN OLD SITE CONFIGS
# ============================================================

- name: Discover existing nginx site configs
  find:
    paths: "{{ edge_gateway_base_path }}/nginx/conf.d"
    patterns: "*.conf"
    file_type: file
  register: existing_nginx_configs

- name: Remove old generated site configs
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ existing_nginx_configs.files }}"

# ============================================================
# CONFIGURATION FILES
# ============================================================

- name: Render docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ edge_gateway_base_path }}/docker-compose.yml"

- name: Render nginx.conf
  template:
    src: nginx.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/nginx.conf"
  notify: Reload edge nginx

- name: Render site configs
  template:
    src: site.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/conf.d/{{ item.domain }}.conf"
  loop: "{{ edge_gateway_apps_dynamic }}"
  notify: Reload edge nginx

# ============================================================
# START STACK
# ============================================================

- name: Start Edge Gateway stack
  command: docker compose up -d
  args:
    chdir: "{{ edge_gateway_base_path }}"

# ============================================================
# HEALTH CHECK (EDGE ELITE SAFETY)
# ============================================================

- name: Wait for edge nginx container to exist
  command: docker inspect edge-nginx
  register: edge_exists
  retries: 10
  delay: 2
  until: edge_exists.rc == 0
  changed_when: false

- name: Wait for edge nginx to become healthy
  command: docker inspect --format='{{ "{{.State.Health.Status}}" }}' edge-nginx
  register: edge_health
  retries: 20
  delay: 3
  until: edge_health.stdout == "healthy"
  changed_when: false
  failed_when: edge_health.stdout != "healthy"

# ============================================================
# AUTO TLS ORCHESTRATION
# ============================================================

- name: Install TLS bootstrap script
  template:
    src: init-letsencrypt.sh.j2
    dest: "{{ edge_gateway_base_path }}/init-letsencrypt.sh"
    mode: "0755"

- name: Install TLS renewal script
  template:
    src: renew-certs.sh.j2
    dest: "{{ edge_gateway_base_path }}/renew-certs.sh"
    mode: "0755"

- name: Check if certificate exists
  stat:
    path: "{{ edge_gateway_base_path }}/certbot/conf/live/{{ edge_gateway_apps_dynamic[0].domain }}/fullchain.pem"
  register: edge_tls_exists
  when: edge_gateway_apps_dynamic | length > 0

- name: Bootstrap TLS certificates
  command: "{{ edge_gateway_base_path }}/init-letsencrypt.sh"
  args:
    chdir: "{{ edge_gateway_base_path }}"
  when:
    - edge_gateway_apps_dynamic | length > 0
    - not edge_tls_exists.stat.exists

- name: Install certificate renewal cron
  cron:
    name: "Edge Gateway TLS renewal"
    minute: "0"
    hour: "3"
    job: "{{ edge_gateway_base_path }}/renew-certs.sh"

# ============================================================
# PHASE 2.6 — WATCHER INSTALL (PAUSED)
# ============================================================

#- name: Install edge watcher script
#  template:
#    src: watch.sh.j2
#    dest: "{{ edge_gateway_base_path }}/scripts/watch.sh"
#    mode: "0755"
