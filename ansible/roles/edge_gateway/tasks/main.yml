---
# ============================================================
# EDGE GATEWAY — CORE DIRECTORIES
# ============================================================

- name: Create base directory
  file:
    path: "{{ edge_gateway_base_path }}"
    state: directory
    mode: "0755"

- name: Create nginx config directory
  file:
    path: "{{ edge_gateway_base_path }}/nginx"
    state: directory
    mode: "0755"

- name: Create certbot directories
  file:
    path: "{{ edge_gateway_base_path }}/certbot/{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - conf
    - www

# ------------------------------------------------------------
# APP AUTO-REGISTRATION DIRECTORY (Phase 2.1)
# ------------------------------------------------------------

- name: Create edge app registry directory
  file:
    path: "{{ edge_gateway_base_path }}/apps"
    state: directory
    mode: "0755"

# ============================================================
# DOCKER NETWORK
# ============================================================

- name: Create docker network
  community.docker.docker_network:
    name: "{{ edge_gateway_network }}"

# ============================================================
# LOAD REGISTERED APPS (AUTO DISCOVERY)
# ============================================================

- name: Discover registered edge apps
  find:
    paths: "{{ edge_gateway_base_path }}/apps"
    patterns: "*.yml"
    file_type: file
  register: discovered_apps

- name: Build dynamic app list
  set_fact:
    edge_gateway_apps_dynamic: >-
      {{
        edge_gateway_apps_dynamic | default([])
        + [ lookup('file', item.path) | from_yaml ]
      }}
  loop: "{{ discovered_apps.files }}"
  when: discovered_apps.matched | int > 0

# ------------------------------------------------------------
# FALLBACK — backward compatibility
# ------------------------------------------------------------

- name: Fallback to static apps if none discovered
  set_fact:
    edge_gateway_apps_dynamic: "{{ edge_gateway_apps | default([]) }}"
  when: edge_gateway_apps_dynamic is not defined

# ============================================================
# CLEAN OLD SITE CONFIGS (VERY IMPORTANT)
# prevents stale upstream crashes
# ============================================================

- name: Discover existing nginx site configs
  find:
    paths: "{{ edge_gateway_base_path }}/nginx"
    patterns: "*.conf"
    file_type: file
  register: existing_nginx_configs

- name: Remove old generated site configs
  file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ existing_nginx_configs.files }}"
  when: item.path | basename != "nginx.conf"

# ============================================================
# PHASE 2.5 — DOCKER LABEL AUTO DISCOVERY
# ============================================================

- name: Discover running docker containers
  community.docker.docker_host_info:
    containers: true
  register: docker_info

- name: Build edge apps from docker labels
  set_fact:
    edge_gateway_apps_dynamic: >-
      {{
        (edge_gateway_apps_dynamic | default([]))
        +
        [
          {
            "domain":
              item.Config.Labels["edge.domain"],
            "upstream":
              item.Name[1:] ~ ":" ~ item.Config.Labels["edge.port"]
          }
        ]
      }}
  loop: "{{ docker_info.containers }}"
  when:
    - item.Config.Labels is defined
    - item.Config.Labels["edge.enable"] is defined
    - item.Config.Labels["edge.enable"] == "true"

# ============================================================
# CONFIGURATION FILES
# ============================================================

- name: Render docker-compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ edge_gateway_base_path }}/docker-compose.yml"

- name: Render nginx.conf
  template:
    src: nginx.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/nginx.conf"
  notify: Reload edge nginx

- name: Render site configs
  template:
    src: site.conf.j2
    dest: "{{ edge_gateway_base_path }}/nginx/{{ item.domain }}.conf"
  loop: "{{ edge_gateway_apps_dynamic }}"
  notify: Reload edge nginx

# ============================================================
# START STACK
# ============================================================

- name: Start Edge Gateway stack
  command: docker compose up -d
  args:
    chdir: "{{ edge_gateway_base_path }}"

# ============================================================
# HEALTH CHECK (EDGE ELITE SAFETY)
# ============================================================

- name: Wait for edge nginx container to exist
  command: docker inspect edge-nginx
  register: edge_exists
  retries: 10
  delay: 2
  until: edge_exists.rc == 0
  changed_when: false

- name: Wait for edge nginx to become healthy
  command: docker inspect --format='{{ "{{.State.Health.Status}}" }}' edge-nginx
  register: edge_health
  retries: 20
  delay: 3
  until: edge_health.stdout == "healthy"
  changed_when: false
  failed_when: false

# ============================================================
# AUTO TLS ORCHESTRATION (Phase 2.4.5)
# ============================================================

- name: Install TLS bootstrap script
  template:
    src: init-letsencrypt.sh.j2
    dest: "{{ edge_gateway_base_path }}/init-letsencrypt.sh"
    mode: "0755"

- name: Install TLS renewal script
  template:
    src: renew-certs.sh.j2
    dest: "{{ edge_gateway_base_path }}/renew-certs.sh"
    mode: "0755"

- name: Bootstrap TLS certificates
  command: "{{ edge_gateway_base_path }}/init-letsencrypt.sh"
  args:
    chdir: "{{ edge_gateway_base_path }}"

- name: Install certificate renewal cron
  cron:
    name: "Edge Gateway TLS renewal"
    minute: "0"
    hour: "3"
    job: "{{ edge_gateway_base_path }}/renew-certs.sh"
