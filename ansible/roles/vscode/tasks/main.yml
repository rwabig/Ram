---
# ============================================================
# VS CODE â€” DIRECTORIES
# ============================================================

- name: Ensure vscode base directory exists
  file:
    path: "{{ vscode_base_path }}"
    state: directory
    mode: "0755"

- name: Ensure vscode data directory exists
  file:
    path: "{{ vscode_base_path }}/data"
    state: directory
    mode: "0755"

# ============================================================
# DOCKER COMPOSE
# ============================================================

- name: Render vscode docker compose
  template:
    src: docker-compose.yml.j2
    dest: "{{ vscode_base_path }}/docker-compose.yml"
    mode: "0644"

- name: Start vscode stack
  command: docker compose up -d
  args:
    chdir: "{{ vscode_base_path }}"
  changed_when: false

# ============================================================
# EDGE REGISTRATION (AUTO DISCOVERY - LEGACY FALLBACK)
# ============================================================

- name: Ensure edge apps directory exists
  file:
    path: "{{ edge_gateway_base_path }}/apps"
    state: directory
    mode: "0755"

- name: Register vscode with edge gateway (fallback mode)
  copy:
    dest: "{{ edge_gateway_base_path }}/apps/vscode.yml"
    content: |
      domain: "{{ vscode_domain }}"
      upstream: "{{ vscode_container_name }}:{{ vscode_port }}"
  notify: Reload edge nginx

# ============================================================
# FUTURE AUTOMATION HOOK (DISABLED)
# ============================================================

- name: Trigger edge rebuild
  command: ansible-playbook playbooks/02-edge-gateway.yml
  when: false
