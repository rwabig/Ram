---
- name: Create app directory
  file:
    path: "{{ app_root }}"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Ensure GitHub is in known_hosts
  known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t ed25519 github.com') }}"
    path: /root/.ssh/known_hosts

- name: Clone or update app repository
  git:
    repo: "{{ app_repo }}"
    dest: "{{ app_root }}"
    version: "{{ app_branch }}"
    force: yes

- name: Copy Dockerfile template
  template:
    src: Dockerfile.j2
    dest: "{{ app_root }}/Dockerfile"

- name: Build PHP image
  community.docker.docker_image:
    name: "{{ app_image_name }}"
    source: build
    force_source: true
    build:
      path: "{{ app_root }}"
      pull: true

- name: Run PHP container
  docker_container:
    name: "{{ app_container_name }}"
    image: "{{ app_image_name }}"
    recreate: true
    restart_policy: unless-stopped
    env:
      DB_HOST: "{{ db_container_name }}"
      DB_NAME: "{{ db_name }}"
      DB_USER: "{{ db_user }}"
      DB_PASS: "{{ db_password }}"
    labels:
      edge.enable: "true"
      edge.domain: "{{ app_domain }}"
      edge.port: "80"
    networks:
      - name: "{{ edge_gateway_network }}"
      - name: "{{ app_network }}"
    state: started
